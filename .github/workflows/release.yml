name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v0.1.0, v1.2.3, etc.
  workflow_dispatch:  # Allows manual triggering
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # First job: Build and verify all crates
  verify:
    name: Verify Release Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --verbose --all-features

      - name: Build release
        run: cargo build --release --all-features

      - name: Verify package builds
        run: |
          cargo package --package aleph-types --allow-dirty
          cargo package --package aleph-sdk --allow-dirty
          cargo package --package aleph-cli --allow-dirty

  # Second job: Check version consistency
  check-versions:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      types-version: ${{ steps.get-version.outputs.types-version }}
      sdk-version: ${{ steps.get-version.outputs.sdk-version }}
      cli-version: ${{ steps.get-version.outputs.cli-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag or input
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Extract versions from Cargo.toml files
          TYPES_VERSION=$(grep '^version = ' crates/aleph-types/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          SDK_VERSION=$(grep '^version = ' crates/aleph-sdk/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          CLI_VERSION=$(grep '^version = ' crates/aleph-cli/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          
          echo "types-version=$TYPES_VERSION" >> $GITHUB_OUTPUT
          echo "sdk-version=$SDK_VERSION" >> $GITHUB_OUTPUT
          echo "cli-version=$CLI_VERSION" >> $GITHUB_OUTPUT
          
          echo "Tag version: $VERSION"
          echo "aleph-types version: $TYPES_VERSION"
          echo "aleph-sdk version: $SDK_VERSION"
          echo "aleph-cli version: $CLI_VERSION"

      - name: Verify version consistency
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          TYPES_VERSION="${{ steps.get-version.outputs.types-version }}"
          SDK_VERSION="${{ steps.get-version.outputs.sdk-version }}"
          CLI_VERSION="${{ steps.get-version.outputs.cli-version }}"
          
          if [ "$VERSION" != "$TYPES_VERSION" ] || [ "$VERSION" != "$SDK_VERSION" ] || [ "$VERSION" != "$CLI_VERSION" ]; then
            echo "Error: Version mismatch detected!"
            echo "Tag version: $VERSION"
            echo "aleph-types: $TYPES_VERSION"
            echo "aleph-sdk: $SDK_VERSION"
            echo "aleph-cli: $CLI_VERSION"
            exit 1
          fi
          
          echo "✓ All versions are consistent: $VERSION"

  # Third job: Get existing release for binary upload
  get-release:
    name: Get Existing Release
    runs-on: ubuntu-latest
    needs: [verify, check-versions]
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.get-release.outputs.upload_url }}
    steps:
      - name: Get release upload URL
        id: get-release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-versions.outputs.version }}';
            const tagName = `v${version}`;
            
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName,
              });
            
              console.log(`Found release: ${release.data.name}`);
              core.setOutput('upload_url', release.data.upload_url);
            
            } catch (error) {
              if (error.status === 404) {
                core.setFailed(`Release with tag ${tagName} not found. Please create the release manually first.`);
              } else {
                throw error;
              }
            }

  # Fourth job: Build release binaries and attach to existing release
  build-binaries:
    name: Build Release Binaries
    needs: [check-versions, get-release]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: aleph
            asset_name: aleph-cli-linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: aleph.exe
            asset_name: aleph-cli-windows-x86_64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: aleph
            asset_name: aleph-cli-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: aleph
            asset_name: aleph-cli-macos-aarch64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --package aleph-cli --target ${{ matrix.target }}

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.get-release.outputs.upload_url }}
          asset_path: ./target/release/${{ matrix.artifact_name }}
          asset_name: ${{ matrix.asset_name }}
          asset_content_type: application/octet-stream

  # Fifth job: Manual approval step before publishing to crates.io
  request-publish-approval:
    name: Request Publish Approval
    runs-on: ubuntu-latest
    needs: [verify, check-versions, build-binaries]
    environment:
      name: crates-io-publish  # Requires manual approval in GitHub
    steps:
      - name: Approval checkpoint
        run: |
          echo "✓ All checks passed"
          echo "✓ Binaries built and attached to release"
          echo "✓ Ready to publish to crates.io"
          echo ""
          echo "Crates to be published:"
          echo "  - aleph-types v${{ needs.check-versions.outputs.version }}"
          echo "  - aleph-sdk v${{ needs.check-versions.outputs.version }}"
          echo "  - aleph-cli v${{ needs.check-versions.outputs.version }}"

  # Sixth job: Publish to crates.io (only runs after manual approval)
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [check-versions, request-publish-approval]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish aleph-types
        run: |
          cd crates/aleph-types
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Wait for aleph-types to be available
        run: |
          echo "Waiting 30 seconds for aleph-types to propagate on crates.io..."
          sleep 30

      - name: Publish aleph-sdk
        run: |
          cd crates/aleph-sdk
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Wait for aleph-sdk to be available
        run: |
          echo "Waiting 30 seconds for aleph-sdk to propagate on crates.io..."
          sleep 30

      - name: Publish aleph-cli
        run: |
          cd crates/aleph-cli
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Update release with crates.io links
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-versions.outputs.version }}';
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const release = releases.data.find(r => r.tag_name === `v${version}`);
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: release.body + '\n\n---\n✅ **Published to crates.io**\n' +
                      `- [aleph-types](https://crates.io/crates/aleph-types/${version})\n` +
                      `- [aleph-sdk](https://crates.io/crates/aleph-sdk/${version})\n` +
                      `- [aleph-cli](https://crates.io/crates/aleph-cli/${version})\n`
              });
            }
